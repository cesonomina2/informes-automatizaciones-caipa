<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documentaci√≥n T√©cnica | SaberBot Casalimpia</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Source+Code+Pro:wght@500&display=swap');

        :root {
            --color-principal: #0085CA; 
            --color-texto: #333333;
            --color-gris-suave: #666666;
            --bg-body: #525659;
            --bg-doc: #ffffff;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-body);
            color: var(--color-texto);
            margin: 0;
            padding: 20px;
            line-height: 1.5;
        }

        /* --- NAVEGACI√ìN (NO SE IMPRIME) --- */
        .nav-bar {
            max-width: 21.6cm;
            margin: 0 auto 15px auto;
            display: flex;
            justify-content: flex-start;
        }

        .btn-volver {
            text-decoration: none;
            color: white;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            background: rgba(255,255,255,0.1);
            padding: 8px 15px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .btn-volver:hover { background: rgba(255,255,255,0.2); }

        /* --- HOJA CARTA --- */
        .document-sheet {
            background-color: var(--bg-doc);
            width: 100%;
            max-width: 21.59cm;
            min-height: 27.94cm;
            margin: 0 auto;
            padding: 2.54cm;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            border-radius: 2px;
        }

        /* --- ENCABEZADO (LOGO + TITULO) --- */
        .header-container {
            display: flex;
            align-items: center; 
            justify-content: space-between; 
            gap: 30px;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 3px solid #eee; 
        }

        .brand-logo {
            height: 75px; 
            width: auto;
            flex-shrink: 0; 
            display: block;
        }

        .title-block {
            flex-grow: 1; 
            text-align: center; 
        }

        h1 {
            color: var(--color-principal);
            font-size: 1.5rem;
            text-transform: uppercase;
            margin: 0;
            line-height: 1.2;
            font-weight: 700;
        }

        .subtitle {
            font-size: 1rem;
            color: var(--color-gris-suave);
            margin-top: 5px;
            font-weight: 400;
        }

        /* --- ESTILOS DEL DOCUMENTO --- */
        h2 { font-size: 1.2rem; color: #2c3e50; border-left: 5px solid var(--color-principal); padding-left: 10px; margin-top: 35px; margin-bottom: 15px; }
        h3 { font-size: 1rem; color: #444; margin-top: 20px; margin-bottom: 10px; font-weight: 700; }
        p, li { font-size: 10pt; color: #333; text-align: justify; margin-bottom: 10px; }
        ul, ol { margin-bottom: 15px; padding-left: 25px; }
        
        /* Tablas */
        .tech-info-table { width: 100%; border-collapse: collapse; margin-bottom: 25px; font-size: 9pt; border: 1px solid #ddd; }
        .tech-info-table td { padding: 6px 10px; border: 1px solid #ddd; vertical-align: top; }
        .td-label { background-color: #f4f4f4; font-weight: 700; width: 25%; color: #444; }

        /* Diagramas y Extras */
        .diagram-container { margin-top: 30px; text-align: center; page-break-inside: avoid; }
        .diagram-title { font-size: 0.95rem; color: #444; font-weight: 700; margin-bottom: 10px; text-align: left; border-left: 3px solid var(--color-principal); padding-left: 10px; }
        .tech-diagram { width: 100%; height: auto; border: 1px solid #ddd; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .img-caption { font-size: 8pt; color: #666; margin-top: 5px; font-style: italic; }
        
        .use-case-box { background-color: #f9fafb; border: 1px solid #e5e7eb; border-left: 3px solid #9ca3af; padding: 12px; margin: 10px 0; font-size: 9pt; font-family: 'Source Code Pro', monospace; page-break-inside: avoid; }
        .dialogue-user { color: #0085CA; font-weight: 600; }
        .dialogue-bot { color: #555; font-style: italic; margin-left: 15px; display: block; margin-bottom: 4px; }
        .secure-link { color: var(--color-principal); text-decoration: none; border-bottom: 1px dotted; word-break: break-all; }
        .alert-box { background: #fff8e1; padding: 10px; border: 1px solid #ffe082; border-radius: 4px; color: #856404; font-size: 9pt; margin-top: 10px; }
        code { font-family: 'Source Code Pro', monospace; background-color: #f7f7f9; padding: 1px 4px; border-radius: 3px; font-size: 0.9em; color: #c0392b; border: 1px solid #e1e1e8; }

        /* Bot√≥n PDF */
        .pdf-section { text-align: center; margin-top: 50px; padding-top: 20px; border-top: 2px solid #eee; }
        .btn-pdf { background-color: #2d3436; color: white; border: none; padding: 10px 20px; font-size: 0.9rem; cursor: pointer; border-radius: 4px; font-family: 'Roboto', sans-serif; display: inline-flex; align-items: center; gap: 8px; }

        /* --- M√ìVILES --- */
        @media (max-width: 768px) {
            body { padding: 0; background-color: #f0f0f0; }
            .nav-bar { padding: 10px; background: #333; max-width: 100%; }
            .document-sheet { width: 100%; max-width: 100%; margin: 0; padding: 20px; box-shadow: none; min-height: 100vh; }
            .header-container { flex-direction: column; text-align: center; gap: 15px; }
            .brand-logo { height: 60px; }
        }

        /* --- IMPRESI√ìN CORREGIDA --- */
        @media print {
            @page { size: letter; margin: 2cm; }
            body { background-color: white; padding: 0; margin: 0; -webkit-print-color-adjust: exact; }
            .document-sheet { 
                box-shadow: none; margin: 0; width: 100%; max-width: 100%; border: none; padding: 0; 
            }
            .nav-bar, .pdf-section, .btn-volver { display: none !important; }
            a { text-decoration: none; color: black; }
            h2, h3, .diagram-container { page-break-after: avoid; }
            img { max-width: 100%; }

            /* FUERZA EL DISE√ëO HORIZONTAL AL IMPRIMIR */
            .header-container {
                display: flex !important;
                flex-direction: row !important;
                align-items: center !important;
                justify-content: flex-start !important;
                border-bottom: 2px solid #ccc !important;
            }
            
            .brand-logo {
                height: 75px !important;
                margin-right: 30px !important;
                display: block !important;
            }

            .title-block {
                text-align: center !important;
                flex: 1 !important;
            }
        }
    </style>
</head>
<body>

    <div class="nav-bar">
        <a href="../index.html" class="btn-volver">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="M12 19l-7-7 7-7"/></svg>
            Volver al Portal
        </a>
    </div>

    <div class="document-sheet">
        
        <div class="header-container">
            <img src="https://empresas.casalimpia.com/wp-content/uploads/2024/08/logo-casa-limpia.png" alt="Casalimpia S.A." class="brand-logo">
            
            <div class="title-block">
                <h1>Informe T√©cnico de Automatizaci√≥n</h1>
                <div class="subtitle">Portal de Autogesti√≥n Desprendibles de Pago y Certificado Laboral</div>
            </div>
        </div>

        <table class="tech-info-table">
            <tr>
                <td class="td-label">Cliente Interno:</td>
                <td>Casalimpia</td>
            </tr>
            <tr>
                <td class="td-label">Plataforma:</td>
                <td>n8n (Workflow Automation)</td>
            </tr>
            <tr>
                <td class="td-label">Carpeta N8N:</td>
                <td>CHAT DESPRENDIBLES Y CARTA LAB</td>
            </tr>
            <tr>
                <td class="td-label">Canal:</td>
                <td>WhatsApp Business API (3044985556)</td>
            </tr>
            <tr>
                <td class="td-label">Estado:</td>
                <td>Producci√≥n (M√≥dulo de Desprendible de N√≥mina) / En Desarrollo (M√≥dulo Certificado Laboral)</td>
            </tr>
        </table>

        <h2>1. Resumen Ejecutivo</h2>
        <p>
            La automatizaci√≥n "Portal de Autogesti√≥n Desprendibles de Pago y Certificado Laboral" es una soluci√≥n de autogesti√≥n desplegada en WhatsApp que permite a los colaboradores de Casalimpia consultar y descargar sus desprendibles de n√≥mina de manera segura y aut√≥noma. El sistema act√∫a como un intermediario seguro entre el usuario y el ERP Novasoft, validando la identidad mediante cruce de datos en tiempo real y gestionando sesiones temporales para garantizar la seguridad de la informaci√≥n.
        </p>

        <h2>2. Arquitectura de la Soluci√≥n</h2>
        
        <h3>2.1. Componentes Tecnol√≥gicos</h3>
        <ul>
            <li><strong>Orquestador:</strong> n8n (Gesti√≥n de l√≥gica, conexiones API y transformaci√≥n de datos).</li>
            <li><strong>Interfaz de Usuario:</strong> WhatsApp (Entrada de texto y recepci√≥n de archivos PDF).</li>
            <li><strong>Backend de Datos (ERP):</strong> Novasoft Web API (Autenticaci√≥n, consulta de datos b√°sicos y generaci√≥n de documentos).</li>
            <li><strong>Base de Datos Transaccional:</strong> Google Sheets (Gesti√≥n de sesiones activas y logs de auditor√≠a).</li>
        </ul>

        <h3>2.2. Estructura de Base de Datos (Google Sheets: DB_BOT_NOMINA)</h3>
        <p>El sistema utiliza una hoja de c√°lculo como base de datos ligera para persistencia de estado y auditor√≠a.</p>
        
        <ul>
            <li><strong>Hoja 1: SESIONES (Control de Acceso)</strong>
                <ul>
                    <li>Almacena los usuarios que han validado su identidad correctamente.</li>
                    <li><strong>Columnas:</strong> Cedula, Nombre, CENTRO DE COSTOS, Fecha, Actualizaci√≥n (Timestamp del √∫ltimo login), Estado (ACTIVO/INACTIVO).</li>
                    <li><strong>Nota:</strong> Esta hoja es monitoreada por un workflow externo ("CERRAR SESION") para invalidar registros tras 10 minutos de inactividad.</li>
                </ul>
            </li>
            <li><strong>Hoja 2: HISTORIAL (Auditor√≠a)</strong>
                <ul>
                    <li>Registra cada transacci√≥n exitosa para trazabilidad.</li>
                    <li><strong>Columnas:</strong> Fecha, Celular, Cedula, Nombre, Jefatura (Centro de Costos), Accion (ej. VALIDACION IDENTIDAD, DESCARGA DESPRENDIBLE), Detalle (ej. Login, Periodo consultado).</li>
                </ul>
            </li>
        </ul>

        <h2>3. Descripci√≥n Detallada del Flujo (Workflow)</h2>
        <p>
            El desarrollo se encuentra organizado en la carpeta CHAT DESPRENDIBLES Y CARTA LAB dentro de n8n. El flujo principal de orquestaci√≥n se denomina MENSAJE INICIAL. Este flujo se inicia con un Trigger de WhatsApp y utiliza un nodo Switch central para enrutar la conversaci√≥n bas√°ndose en el contenido del mensaje del usuario.
        </p>

        <h3>3.1. Flujo de Validaci√≥n de Identidad (Inicio de Sesi√≥n)</h3>
        <p>Este proceso se activa cuando el usuario env√≠a un n√∫mero de documento (Definido entre 5 y 15 caracteres con la regla de validaci√≥n ‚ÄúRegex: <code>^\d{5,15}$</code>‚Äù).</p>
        <ol>
            <li><strong>Autenticaci√≥n:</strong> El bot realiza un login t√©cnico en Novasoft (<code>/api/Cuenta/Login</code>) para obtener un token de autorizaci√≥n.</li>
            <li><strong>Consulta de Datos:</strong> Se consulta el endpoint <code>/api/NOM/ConsultaDatos/{cedula}</code>.</li>
            <li><strong>Verificaci√≥n de Seguridad (MFA Impl√≠cito):</strong>
                <ul>
                    <li>El sistema compara el n√∫mero de celular desde el que escribe el usuario (WhatsApp ID) contra el campo ‚ÄútelCel‚Äù retornado por Novasoft.</li>
                    <li><strong>Caso √âxito:</strong> Si los n√∫meros coinciden, se registra al usuario en la Hoja 1 (Sesiones) con estado "ACTIVO" y se env√≠a el men√∫ principal.</li>
                    <li><strong>Caso Fallido:</strong> Si no coinciden, se env√≠a un mensaje de "Acceso Denegado", protegiendo la informaci√≥n del empleado real.</li>
                </ul>
            </li>
        </ol>

        <h3>3.2. Flujo de Men√∫ Principal</h3>
        <ul>
            <li><strong>Opci√≥n "1" (M√≥dulo de Desprendible de N√≥mina):</strong> El bot responde solicitando el periodo en formato Mes-A√±o (ej. 1-2024).</li>
            <li><strong>Opci√≥n "2" (M√≥dulo Certificado Laboral):</strong> Verifica si el usuario tiene sesi√≥n activa en Hoja 1.
                <ul>
                    <li>Registra la intenci√≥n en Hoja 2 (Historial).</li>
                    <li>Responde con un mensaje de "M√≥dulo en Construcci√≥n" (Funcionalidad pendiente de integraci√≥n con API de certificados).</li>
                </ul>
            </li>
        </ul>

        <h3>3.3. Flujo de Descarga de Desprendibles</h3>
        <p>Este proceso se activa cuando el usuario env√≠a una fecha con formato v√°lido (Regex: <code>^\d{1,2}-\d{4}$</code>).</p>
        <ol>
            <li><strong>Verificaci√≥n de Sesi√≥n:</strong> Consulta en Hoja 1 si el n√∫mero de celular tiene una sesi√≥n con estado "ACTIVO". Si no existe o est√° inactiva, bloquea la solicitud.</li>
            <li><strong>C√°lculo de Fechas:</strong> Un nodo de c√≥digo (JavaScript) transforma el input Mes-A√±o (ej. 1-2024) en el formato de fecha ISO requerido por Novasoft (Primer d√≠a YYYY-MM-01 al √∫ltimo d√≠a del mes).</li>
            <li><strong>Generaci√≥n de Documento:</strong> Realiza login t√©cnico en Novasoft.
                <ul>
                    <li>Consume el endpoint <code>/api/NOM/CertificadoComprobantePagoPdf</code> enviando las fechas calculadas y la c√©dula recuperada de la sesi√≥n.</li>
                </ul>
            </li>
            <li><strong>Procesamiento de Archivo:</strong>
                <ul>
                    <li>Recibe el PDF en formato Base64.</li>
                    <li>Transforma el Base64 a archivo binario mediante c√≥digo.</li>
                    <li>Nombra el archivo como <code>Desprendible_{Cedula}.pdf</code>.</li>
                </ul>
            </li>
            <li><strong>Entrega y Auditor√≠a:</strong>
                <ul>
                    <li>Env√≠a el PDF al usuario por WhatsApp.</li>
                    <li>Registra la descarga en Hoja 2 (Historial) con el detalle del periodo consultado.</li>
                </ul>
            </li>
        </ol>

        <h2>4. Reglas de Negocio y Restricciones</h2>
        <ul>
            <li><strong>Seguridad por Coincidencia de L√≠nea:</strong> Es obligatorio que el empleado escriba desde el n√∫mero de celular que tiene registrado en la base de datos de la empresa. No se permite consultar datos de terceros.</li>
            <li><strong>Sesi√≥n Temporal:</strong> Aunque el usuario quede registrado en Google Sheets, existe un proceso externo ("CERRAR SESION") que inactiva o borra registros antiguos para obligar a una nueva validaci√≥n peri√≥dica.</li>
            <li><strong>Formato de Fecha Estricto:</strong> El sistema solo acepta el formato M-AAAA o MM-AAAA (ej. 1-2024 o 12-2023). Cualquier otro formato en esta etapa activar√° el mensaje de ayuda por defecto.</li>
            <li><strong>Datos Limpios:</strong> La c√©dula debe ingresarse sin puntos, comas ni espacios para que el Regex la detecte correctamente.</li>
        </ul>

        <h2>5. Casos de Uso (User Journey)</h2>

        <div class="use-case-box">
            <strong>Caso A: Usuario Nuevo (Datos Correctos)</strong><br><br>
            <span class="dialogue-user">Usuario: "Hola"</span>
            <span class="dialogue-bot">Bot: "Bienvenido... por favor digite su n√∫mero de documento"</span>
            <span class="dialogue-user">Usuario: "1073249765"</span>
            <span class="dialogue-bot">Bot: (Valida internamente √©xito) "Identidad Validada. Hola Juan... Selecciona 1 o 2"</span>
            <span class="dialogue-user">Usuario: "1"</span>
            <span class="dialogue-bot">Bot: "Por favor escribe el periodo (Mes-A√±o)... ej: 1-2024"</span>
            <span class="dialogue-user">Usuario: "1-2024"</span>
            <span class="dialogue-bot">Bot: (Env√≠a PDF) "Desprendible_1073249765.pdf"</span>
        </div>

        <div class="use-case-box">
            <strong>Caso B: Intento de Suplantaci√≥n (Celular o Cedula no coinciden)</strong><br><br>
            <span class="dialogue-user">Usuario: (Desde celular 3001112233) Escribe c√©dula "555555"</span>
            <span class="dialogue-bot">Bot: Consulta Novasoft. El celular registrado para 555555 es 3109998877.</span>
            <span class="dialogue-bot">Bot: "üîí Acceso Denegado. El n√∫mero de celular desde el que escribes no coincide con el registrado..."</span>
        </div>

        <div class="use-case-box">
            <strong>Caso C: Sesi√≥n Expirada o Intento de Acceso Directo</strong><br><br>
            <span class="dialogue-user">Usuario: Escribe "1-2024" sin haberse validado previamente.</span>
            <span class="dialogue-bot">Bot: Verifica Hoja 1 y no encuentra sesi√≥n ACTIVA.</span>
            <span class="dialogue-bot">Bot: "‚ö†Ô∏è No te reconozco. Antes de generar un certificado, necesito validar tu identidad..."</span>
        </div>

        <h2>6. Pr√≥ximos Pasos</h2>
        <ul>
            <li><strong>M√≥dulo Certificado Laboral:</strong> Completar el flujo de la opci√≥n "2" conectando al endpoint de certificados de Novasoft (similar al flujo de desprendible de n√≥mina).</li>
            <li><strong>Migraci√≥n a Base de Datos Vectorial:</strong> Actualizar la base de datos actual basada en Google Sheets (Drive) por una infraestructura de base de datos vectorial (ej. Pinecone, Weaviate o pgvector).
                <ul>
                    <li><strong>Ventajas Estrat√©gicas:</strong></li>
                    <li><strong>B√∫squeda Sem√°ntica:</strong> Permite al bot entender la intenci√≥n del usuario m√°s all√° de palabras clave exactas.</li>
                    <li><strong>Escalabilidad y Velocidad:</strong> Manejo eficiente de grandes vol√∫menes de datos hist√≥ricos y reducci√≥n de latencia en consultas concurrentes, superando las limitaciones de filas de Google Sheets.</li>
                </ul>
            </li>
            <li><strong>Integraci√≥n con IA Generativa (RAG) para Interpretaci√≥n de Desprendibles:</strong> Implementar una capa de inteligencia artificial que habilite la capacidad de conectar Modelos de Lenguaje (LLMs). Esto permitir√° que el bot pueda "leer" el contenido del desprendible generado y responder preguntas espec√≠ficas sobre la informaci√≥n all√≠ contenida.
                <ul>
                    <li><strong>Caso de Uso:</strong> El usuario podr√° realizar consultas como "¬øPor qu√© tengo un descuento de X valor?", "¬øCu√°nto me pagaron de horas extras?" o "¬øCu√°l es el total de deducciones este mes?", obteniendo respuestas inmediatas y contextualizadas basadas en sus propios datos de n√≥mina.</li>
                </ul>
            </li>
        </ul>

        <h2>7. Anexos y Recursos</h2>
        <p><strong>Repositorio de Datos (Acceso Restringido)</strong><br>
        Recurso: Base de Datos Transaccional (Google Sheets - DB_BOT_NOMINA)</p>
        <p>Enlace: <a href="https://docs.google.com/spreadsheets/d/1lb0VUVQr_Yo1bnAAOUyYpT6XtoBqs0PB3WsHxR5E25Y/edit?usp=sharing" target="_blank" class="secure-link">https://docs.google.com/spreadsheets/d/1lb0VUVQr_Yo1bnAAOUyYpT6XtoBqs0PB3WsHxR5E25Y/edit?usp=sharing</a></p>
        
        <div class="alert-box">
            <strong>‚ö†Ô∏è Pol√≠tica de Seguridad:</strong> Este archivo contiene informaci√≥n confidencial de los colaboradores. El acceso est√° estrictamente restringido y reservado √∫nicamente para el personal autorizado.
        </div>

        <div class="diagram-container">
            <div class="diagram-title">Anexo 7.1. Diagrama de Flujo: MENSAJE INICIAL (Orquestaci√≥n Principal)</div>
            <img src="flujo_inicial.png" alt="Diagrama Flujo Mensaje Inicial" class="tech-diagram">
            <p class="img-caption">Figura 1. Vista l√≥gica del flujo de validaci√≥n de identidad y direccionamiento.</p>
        </div>

        <div class="diagram-container">
            <div class="diagram-title">Anexo 7.2. Diagrama de Flujo: CERRAR SESI√ìN (Mantenimiento)</div>
            <img src="flujo_cierre.png" alt="Diagrama Flujo Cerrar Sesi√≥n" class="tech-diagram">
            <p class="img-caption">Figura 2. Proceso autom√°tico de limpieza de sesiones inactivas.</p>
        </div>

        <div class="pdf-section">
            <button onclick="window.print()" class="btn-pdf">
                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9V2h12v7"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><path d="M6 14h12v8H6z"/></svg>
                Imprimir Documento / Guardar PDF
            </button>
        </div>

    </div>

</body>
</html>